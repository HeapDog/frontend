name: Deploy to VM via Tailscale

on:
  push:
    branches: ["main"]
  workflow_dispatch: {}

concurrency:
  group: deploy-to-vm
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo (optional)
        uses: actions/checkout@v4

      # Start Tailscale on the runner using the official GitHub Action.
      # The action reads the client id / secret from env here (you said you already put them as secrets).
      - name: Start Tailscale
        uses: tailscale/github-action@v4
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:ci 

      - name: SSH to VM and deploy
        # we use a single ssh call that runs a small bash deployment script on the remote host
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_IP }} << 'REMOTE'
          set -euo pipefail

          echo "Entering project directory..."
          cd '${{ secrets.PROJECT_PATH }}/frontend'

          echo "Pulling latest from origin/main..."
          git fetch origin main
          git reset --hard origin/main

          echo "Stopping frontend service (if running)..."
          docker compose -f compose.yml stop frontend || true

          echo "Removing old container (if exists)..."
          docker compose -f compose.yml rm -f frontend || true

          echo "Building the frontend container..."
          docker compose -f compose.yml build frontend

          echo "Starting the frontend container in headless/detached mode..."
          docker compose -f compose.yml up -d --no-deps --force-recreate frontend

          echo "Cleaning up unused images and containers..."
          docker image prune -af || true
          docker container prune -f || true
          docker system prune -f || true

          echo "Deployment finished successfully."
          exit 0
          REMOTE_SCRIPT

          ssh_exit=$?
          echo "SSH client exit code: $ssh_exit"

          if [ "$ssh_exit" -ne 0 ]; then
            echo "ERROR: SSH command returned non-zero exit code: $ssh_exit"
            exit $ssh_exit
          fi

          echo "Workflow step completed (ssh returned 0)."
