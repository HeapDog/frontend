name: Deploy to VM via Tailscale

on:
  push:
    branches: ["main"]
  workflow_dispatch: {}

concurrency:
  group: deploy-to-vm
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo (optional)
        uses: actions/checkout@v4

      # Start Tailscale on the runner using the official GitHub Action.
      # The action reads the client id / secret from env here (you said you already put them as secrets).
      - name: Start Tailscale
        uses: tailscale/github-action@v4
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:ci 

      - name: SSH to VM and deploy
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_IP }} "
            echo "Entering project directory..."
            cd ${{ secrets.PROJECT_PATH }}/frontend
            echo "Pulling latest from origin/main..."
            git fetch origin main
            git reset --hard origin/main
            echo "Stopping frontend service (if running)..."
            docker compose stop frontend
            echo "Removing old container (if exists)..."
            docker compose rm -f frontend
            echo "Building the frontend container..."
            docker compose build frontend
            echo "Starting the frontend container in headless mode..."
            docker compose up -d --no-deps --force-recreate frontend
            echo "Cleaning up unused images and containers..."
            docker image prune -af
            docker container prune -f
            docker system prune -f
            echo "Deployment finished successfully.
          "
